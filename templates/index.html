<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clinical Trials Prospector</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5; padding: 20px; color: #333;
    }
    .container {
      max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px;
    }
    h1 { color: #2563eb; margin-bottom: 10px; font-size: 2em; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 1.1em; }
    .info-badge {
      background: #10b981; color: white; padding: 8px 15px; border-radius: 20px;
      display: inline-block; font-size: 0.9em; font-weight: 600; margin-bottom: 20px;
    }
    .section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 25px; margin-bottom: 20px;
    }
    .section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.2em; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;
      font-size: 14px; font-family: inherit;
    }
    textarea { min-height: 80px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .hint { font-size: 13px; color: #6b7280; margin-top: 5px; }
    .filters {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px; margin-top: 15px;
    }
    .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .checkbox-group label { 
      display: flex; gap: 8px; align-items: center; font-weight: normal;
      cursor: pointer;
    }
    
    .org-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }
    .org-type-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .org-type-card:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .org-type-card.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }
    .org-type-card input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .org-type-label {
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
    }
    .org-type-count {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* Drag and Drop Column Builder */
    .column-builder {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .column-pool, .column-selected {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      min-height: 400px;
    }
    
    .column-pool h4, .column-selected h4 {
      color: #1f2937;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .column-count {
      font-size: 12px;
      color: #6b7280;
      font-weight: normal;
    }
    
    .column-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 300px;
    }
    
    .column-item {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
      user-select: none;
    }
    
    .column-item:hover {
      background: #eff6ff;
      border-color: #2563eb;
    }
    
    .column-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .column-item.drag-over {
      border-color: #10b981;
      background: #d1fae5;
    }
    
    .column-item-info {
      flex: 1;
    }
    
    .column-item-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    
    .column-item-desc {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .column-item-handle {
      color: #9ca3af;
      font-size: 20px;
      cursor: grab;
    }
    
    .column-item-handle:active {
      cursor: grabbing;
    }
    
    .column-item-order {
      background: #2563eb;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      margin-right: 10px;
    }
    
    .column-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-small {
      padding: 8px 16px;
      background: white;
      color: #2563eb;
      border: 1px solid #2563eb;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-small:hover {
      background: #eff6ff;
    }
    
    .btn-small.primary {
      background: #2563eb;
      color: white;
    }
    
    .btn-small.primary:hover {
      background: #1d4ed8;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .column-pool .empty-state {
      display: none;
    }
    
    .column-pool:not(:has(.column-item)) .empty-state {
      display: block;
    }
    
    .column-selected .empty-state {
      display: none;
    }
    
    .column-selected:not(:has(.column-item)) .empty-state {
      display: block;
    }
    
    .btn {
      width: 100%; padding: 14px; background: #2563eb; color: white;
      border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover:not(:disabled) { background: #1d4ed8; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .loading { text-align: center; padding: 30px; display: none; }
    .loading.active { display: block; }
    .spinner {
      width: 40px; height: 40px; margin: 0 auto 15px;
      border: 3px solid #e5e7eb; border-top: 3px solid #2563eb;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .status-text { color: #6b7280; font-size: 14px; }
    .error {
      background: #fee; border: 1px solid #fca5a5; color: #b91c1c;
      padding: 15px; border-radius: 6px; margin: 15px 0; display: none;
    }
    .error.active { display: block; }
    .results { margin-top: 30px; display: none; }
    .results.active { display: block; }
    .results-header {
      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .results-header h2 { color: #1e40af; margin-bottom: 15px; }
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    .stat-box { text-align: center; padding: 15px; background: white; border-radius: 6px; }
    .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; }
    .stat-label { color: #6b7280; font-size: 13px; margin-top: 5px; }
    .companies-section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .companies-list { max-height: 500px; overflow-y: auto; margin-top: 15px; }
    .company-item {
      background: white; border: 1px solid #e5e7eb; border-radius: 4px;
      padding: 12px 15px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .company-name { font-weight: 600; color: #1f2937; }
    .company-type { color: #6b7280; font-size: 13px; margin-top: 3px; }
    .company-org-type {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-top: 4px;
    }
    .company-count { color: #2563eb; font-weight: bold; font-size: 1.3em; }
    .export-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .btn-secondary { background: #10b981; }
    .btn-secondary:hover:not(:disabled) { background: #059669; }
    .info {
      background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;
      padding: 20px; margin-top: 25px;
    }
    .info h3 { color: #0369a1; margin-bottom: 12px; }
    .info ul { color: #0c4a6e; padding-left: 20px; }
    .info li { margin: 8px 0; line-height: 1.5; }
    
    .toggle-section {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    
    .toggle-section:hover {
      background: #eff6ff;
    }
    
    .toggle-icon {
      transition: transform 0.3s;
    }
    
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.open {
      max-height: 2000px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Clinical Trials Prospector</h1>
    <p class="subtitle">Search and export clinical trials data with custom Excel structure</p>
    <div class="info-badge">âœ“ Drag & Drop Excel Column Builder</div>

    <div class="section">
      <h3>Search Parameters</h3>

      <div class="form-group">
        <label for="keywords">Keywords *</label>
        <textarea id="keywords" placeholder="Enter keywords separated by commas (e.g., diabetes, CAR-T therapy, cardiovascular)"></textarea>
        <div class="hint">Tip: Use commas to add multiple keywords. Example: <b>mRNA, vaccine</b></div>
      </div>

      <div class="filters">
        <div class="form-group">
          <label>Study Status</label>
          <label style="margin-bottom:10px;">
            <input type="checkbox" id="statusSelectAll" />
            <span>Select all</span>
          </label>
          <div class="checkbox-group" id="status-group">
            <label><input type="checkbox" value="RECRUITING"> Recruiting</label>
            <label><input type="checkbox" value="ACTIVE_NOT_RECRUITING"> Active, not recruiting</label>
            <label><input type="checkbox" value="COMPLETED"> Completed</label>
            <label><input type="checkbox" value="ENROLLING_BY_INVITATION"> Enrolling by invitation</label>
            <label><input type="checkbox" value="NOT_YET_RECRUITING"> Not yet recruiting</label>
            <label><input type="checkbox" value="SUSPENDED"> Suspended</label>
            <label><input type="checkbox" value="TERMINATED"> Terminated</label>
            <label><input type="checkbox" value="WITHDRAWN"> Withdrawn</label>
          </div>
        </div>

        <div class="form-group">
          <label>Study Phase</label>
          <label style="margin-bottom:10px;">
            <input type="checkbox" id="phaseSelectAll" />
            <span>Select all</span>
          </label>
          <div class="checkbox-group" id="phase-group">
            <label><input type="checkbox" value="EARLY_PHASE1"> Early Phase 1</label>
            <label><input type="checkbox" value="PHASE1"> Phase 1</label>
            <label><input type="checkbox" value="PHASE2"> Phase 2</label>
            <label><input type="checkbox" value="PHASE3"> Phase 3</label>
            <label><input type="checkbox" value="PHASE4"> Phase 4</label>
          </div>
        </div>

        <div class="form-group">
          <label for="maxResults">Max Results</label>
          <select id="maxResults">
            <option value="100">100 studies</option>
            <option value="250">250 studies</option>
            <option value="500" selected>500 studies</option>
            <option value="1000">1000 studies</option>
            <option value="ALL">All results</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Data Extraction Options (Collapsible) -->
    <div class="toggle-section" onclick="toggleSection('dataExtractSection')">
      <div>
        <h3 style="margin: 0;">Data to Extract</h3>
        <div class="hint">Select which information to collect from each trial</div>
      </div>
      <span class="toggle-icon" id="dataExtractToggle">â–¼</span>
    </div>
    
    <div class="collapsible-content" id="dataExtractSection">
      <div class="section" style="margin-top: 0;">
        <label style="margin-bottom:15px; display: flex; gap: 8px; align-items: center; cursor: pointer;">
          <input type="checkbox" id="dataExtractSelectAll" />
          <span style="font-weight: 600; color: #1f2937;">Select All Data Fields</span>
        </label>

        <div class="org-types-grid" id="dataExtractGrid">
          <div class="org-type-card selected" data-extract="sponsors">
            <label>
              <input type="checkbox" value="sponsors" checked />
              <span class="org-type-label">Sponsors & Collaborators</span>
            </label>
            <div class="org-type-count">Lead sponsor, collaborators</div>
          </div>

          <div class="org-type-card" data-extract="investigators">
            <label>
              <input type="checkbox" value="investigators" />
              <span class="org-type-label">Principal Investigators</span>
            </label>
            <div class="org-type-count">Lead researchers, affiliations</div>
          </div>

          <div class="org-type-card" data-extract="locations">
            <label>
              <input type="checkbox" value="locations" />
              <span class="org-type-label">Study Locations</span>
            </label>
            <div class="org-type-count">Facilities, cities, countries</div>
          </div>

          <div class="org-type-card" data-extract="interventions">
            <label>
              <input type="checkbox" value="interventions" />
              <span class="org-type-label">Interventions</span>
            </label>
            <div class="org-type-count">Drugs, devices, procedures</div>
          </div>

          <div class="org-type-card" data-extract="conditions">
            <label>
              <input type="checkbox" value="conditions" />
              <span class="org-type-label">Conditions</span>
            </label>
            <div class="org-type-count">Diseases being studied</div>
          </div>

          <div class="org-type-card" data-extract="outcomes">
            <label>
              <input type="checkbox" value="outcomes" />
              <span class="org-type-label">Study Outcomes</span>
            </label>
            <div class="org-type-count">Primary, secondary measures</div>
          </div>

          <div class="org-type-card" data-extract="design">
            <label>
              <input type="checkbox" value="design" />
              <span class="org-type-label">Study Design</span>
            </label>
            <div class="org-type-count">Phase, enrollment, randomization</div>
          </div>

          <div class="org-type-card" data-extract="eligibility">
            <label>
              <input type="checkbox" value="eligibility" />
              <span class="org-type-label">Eligibility Criteria</span>
            </label>
            <div class="org-type-count">Age, gender, inclusion criteria</div>
          </div>

          <div class="org-type-card" data-extract="contacts">
            <label>
              <input type="checkbox" value="contacts" />
              <span class="org-type-label">Contact Information</span>
            </label>
            <div class="org-type-count">Recruitment contacts, emails</div>
          </div>

          <div class="org-type-card" data-extract="timeline">
            <label>
              <input type="checkbox" value="timeline" />
              <span class="org-type-label">Dates & Timeline</span>
            </label>
            <div class="org-type-count">Start, completion, update dates</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Organization Types (Collapsible) -->
    <div class="toggle-section" onclick="toggleSection('orgTypesSection')">
      <div>
        <h3 style="margin: 0;">Organization Types to Include</h3>
        <div class="hint">Filter by organization type</div>
      </div>
      <span class="toggle-icon" id="orgTypesToggle">â–¼</span>
    </div>
    
    <div class="collapsible-content" id="orgTypesSection">
      <div class="section" style="margin-top: 0;">
        <label style="margin-bottom:15px; display: flex; gap: 8px; align-items: center; cursor: pointer;">
          <input type="checkbox" id="orgTypesSelectAll" />
          <span style="font-weight: 600; color: #1f2937;">Select All Organization Types</span>
        </label>

        <div class="org-types-grid" id="orgTypesGrid">
          <div class="org-type-card selected" data-type="company">
            <label>
              <input type="checkbox" value="company" checked />
              <span class="org-type-label">Commercial Companies</span>
            </label>
            <div class="org-type-count">Biotech, pharma, CROs, etc.</div>
          </div>

          <div class="org-type-card" data-type="university">
            <label>
              <input type="checkbox" value="university" />
              <span class="org-type-label">Universities & Colleges</span>
            </label>
            <div class="org-type-count">Academic institutions</div>
          </div>

          <div class="org-type-card" data-type="hospital">
            <label>
              <input type="checkbox" value="hospital" />
              <span class="org-type-label">Hospitals & Medical Centers</span>
            </label>
            <div class="org-type-count">Healthcare facilities</div>
          </div>

          <div class="org-type-card" data-type="institute">
            <label>
              <input type="checkbox" value="institute" />
              <span class="org-type-label">Research Institutes</span>
            </label>
            <div class="org-type-count">Independent research centers</div>
          </div>

          <div class="org-type-card" data-type="government">
            <label>
              <input type="checkbox" value="government" />
              <span class="org-type-label">Government Agencies</span>
            </label>
            <div class="org-type-count">NIH, VA, public health</div>
          </div>

          <div class="org-type-card" data-type="academic">
            <label>
              <input type="checkbox" value="academic" />
              <span class="org-type-label">Academic Medical Centers</span>
            </label>
            <div class="org-type-count">University hospitals</div>
          </div>

          <div class="org-type-card" data-type="foundation">
            <label>
              <input type="checkbox" value="foundation" />
              <span class="org-type-label">Foundations & Trusts</span>
            </label>
            <div class="org-type-count">Charitable organizations</div>
          </div>

          <div class="org-type-card" data-type="nonprofit">
            <label>
              <input type="checkbox" value="nonprofit" />
              <span class="org-type-label">Non-Profit Organizations</span>
            </label>
            <div class="org-type-count">Societies, associations</div>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: Excel Column Builder -->
    <div class="section">
      <h3>ðŸ“Š Customize Excel Export Structure (Drag & Drop)</h3>
      <div class="hint" style="margin-bottom: 15px;">
        Drag columns from left to right to build your custom Excel structure. Reorder by dragging up/down in the right panel.
      </div>

      <div class="column-builder">
        <!-- Available Columns Pool -->
        <div class="column-pool">
          <h4>
            Available Columns
            <span class="column-count" id="poolCount">0 columns</span>
          </h4>
          <div class="column-list" id="columnPool">
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“¦</div>
              <div>All columns are selected</div>
            </div>
          </div>
        </div>

        <!-- Selected Columns -->
        <div class="column-selected">
          <h4>
            Excel Export Columns (in order)
            <span class="column-count" id="selectedCount">0 columns</span>
          </h4>
          <div class="column-list" id="columnSelected">
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“‹</div>
              <div>Drag columns here to build your export</div>
            </div>
          </div>
          
          <div class="column-actions">
            <button class="btn-small" onclick="clearAllColumns()">Clear All</button>
            <button class="btn-small" onclick="selectDefaultColumns()">Use Defaults</button>
            <button class="btn-small primary" onclick="selectAllColumns()">Add All Columns</button>
          </div>
        </div>
      </div>
    </div>

    <button class="btn" id="searchBtn" onclick="searchTrials()">Search Clinical Trials</button>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Loading...</div>
    </div>

    <div id="error" class="error"></div>

    <div id="results" class="results">
      <div class="results-header">
        <h2>Results</h2>
        <div class="stats" id="stats"></div>
      </div>

      <div class="companies-section">
        <h3>Extracted Data (Preview)</h3>
        <div class="companies-list" id="companiesList"></div>
      </div>

      <div class="export-buttons">
        <button class="btn btn-secondary" onclick="exportToExcel()">ðŸ“Š Export to Excel (XLSX)</button>
      </div>
    </div>

    <div class="info">
      <h3>Features</h3>
      <ul>
        <li><b>Drag & Drop Column Builder:</b> Customize your Excel export structure by dragging columns</li>
        <li><b>Column Ordering:</b> Reorder columns by dragging them up or down in the right panel</li>
        <li><b>Flexible Data Extraction:</b> Choose exactly which data fields you need (10 categories)</li>
        <li><b>Organization Filtering:</b> Select which organization types to include</li>
        <li><b>Professional Excel Export:</b> Formatted headers, auto-adjusted columns, freeze panes</li>
      </ul>
    </div>
  </div>

  <script>
    /**
     * Column Builder - Drag and Drop functionality
     * Integrated directly to avoid loading issues
     */

    // Column definitions with all possible fields
    const COLUMN_DEFINITIONS = {
      // Basic Info
      nct_id: { name: 'NCT ID', desc: 'Trial identifier', category: 'basic' },
      title: { name: 'Study Title', desc: 'Brief title of the study', category: 'basic' },
      status: { name: 'Status', desc: 'Overall study status', category: 'basic' },
      
      // Sponsors (always available)
      lead_sponsor: { name: 'Lead Sponsor', desc: 'Primary organization', category: 'sponsors', requires: 'sponsors' },
      lead_sponsor_type: { name: 'Sponsor Type', desc: 'Organization category', category: 'sponsors', requires: 'sponsors' },
      lead_sponsor_class: { name: 'Sponsor Class', desc: 'Industry/NIH/Other', category: 'sponsors', requires: 'sponsors' },
      collaborators: { name: 'Collaborators', desc: 'All collaborating organizations', category: 'sponsors', requires: 'sponsors' },
      collaborator_count: { name: 'Collaborator Count', desc: 'Number of collaborators', category: 'sponsors', requires: 'sponsors' },
      
      // Investigators
      principal_investigators: { name: 'Principal Investigators', desc: 'Lead researcher names', category: 'investigators', requires: 'investigators' },
      pi_affiliations: { name: 'PI Affiliations', desc: 'PI institutions', category: 'investigators', requires: 'investigators' },
      pi_count: { name: 'PI Count', desc: 'Number of PIs', category: 'investigators', requires: 'investigators' },
      
      // Locations
      facilities: { name: 'Facilities', desc: 'Hospital/clinic names', category: 'locations', requires: 'locations' },
      cities: { name: 'Cities', desc: 'Study locations', category: 'locations', requires: 'locations' },
      countries: { name: 'Countries', desc: 'Countries', category: 'locations', requires: 'locations' },
      location_count: { name: 'Location Count', desc: 'Number of sites', category: 'locations', requires: 'locations' },
      
      // Interventions
      drugs: { name: 'Drugs', desc: 'Medications tested', category: 'interventions', requires: 'interventions' },
      devices: { name: 'Devices', desc: 'Medical devices', category: 'interventions', requires: 'interventions' },
      procedures: { name: 'Procedures', desc: 'Surgical procedures', category: 'interventions', requires: 'interventions' },
      other_interventions: { name: 'Other Interventions', desc: 'Other types', category: 'interventions', requires: 'interventions' },
      intervention_count: { name: 'Intervention Count', desc: 'Total interventions', category: 'interventions', requires: 'interventions' },
      
      // Conditions
      conditions: { name: 'Conditions', desc: 'Diseases studied', category: 'conditions', requires: 'conditions' },
      keywords: { name: 'Keywords', desc: 'Study keywords', category: 'conditions', requires: 'conditions' },
      condition_count: { name: 'Condition Count', desc: 'Number of conditions', category: 'conditions', requires: 'conditions' },
      
      // Outcomes
      primary_outcomes: { name: 'Primary Outcomes', desc: 'Main endpoints', category: 'outcomes', requires: 'outcomes' },
      secondary_outcomes: { name: 'Secondary Outcomes', desc: 'Additional endpoints', category: 'outcomes', requires: 'outcomes' },
      primary_outcome_count: { name: 'Primary Outcome Count', desc: 'Number of primary', category: 'outcomes', requires: 'outcomes' },
      secondary_outcome_count: { name: 'Secondary Outcome Count', desc: 'Number of secondary', category: 'outcomes', requires: 'outcomes' },
      
      // Design
      phase: { name: 'Phase', desc: 'Study phase', category: 'design', requires: 'design' },
      study_type: { name: 'Study Type', desc: 'Interventional/Observational', category: 'design', requires: 'design' },
      enrollment: { name: 'Enrollment', desc: 'Number of participants', category: 'design', requires: 'design' },
      allocation: { name: 'Allocation', desc: 'Randomized/Non-randomized', category: 'design', requires: 'design' },
      intervention_model: { name: 'Intervention Model', desc: 'Parallel/Crossover/etc', category: 'design', requires: 'design' },
      primary_purpose: { name: 'Primary Purpose', desc: 'Treatment/Prevention/etc', category: 'design', requires: 'design' },
      masking: { name: 'Masking', desc: 'Blinding details', category: 'design', requires: 'design' },
      
      // Eligibility
      min_age: { name: 'Min Age', desc: 'Minimum age', category: 'eligibility', requires: 'eligibility' },
      max_age: { name: 'Max Age', desc: 'Maximum age', category: 'eligibility', requires: 'eligibility' },
      sex: { name: 'Sex', desc: 'Gender requirements', category: 'eligibility', requires: 'eligibility' },
      healthy_volunteers: { name: 'Healthy Volunteers', desc: 'Accepts healthy volunteers', category: 'eligibility', requires: 'eligibility' },
      eligibility_criteria: { name: 'Eligibility Criteria', desc: 'Full criteria text', category: 'eligibility', requires: 'eligibility' },
      
      // Contacts
      contact_name: { name: 'Contact Name', desc: 'Recruitment contact', category: 'contacts', requires: 'contacts' },
      contact_email: { name: 'Contact Email', desc: 'Email address', category: 'contacts', requires: 'contacts' },
      contact_phone: { name: 'Contact Phone', desc: 'Phone number', category: 'contacts', requires: 'contacts' },
      
      // Timeline
      start_date: { name: 'Start Date', desc: 'Study start date', category: 'timeline', requires: 'timeline' },
      completion_date: { name: 'Completion Date', desc: 'Expected completion', category: 'timeline', requires: 'timeline' },
      last_update: { name: 'Last Update', desc: 'Last modified date', category: 'timeline', requires: 'timeline' }
    };

    // Drag and drop state
    let draggedElement = null;
    let draggedFromPool = null;

    /**
     * Create a column item element
     */
    function createColumnItem(columnKey, showOrder = false, order = null) {
      const def = COLUMN_DEFINITIONS[columnKey];
      if (!def) return null;
      
      const item = document.createElement('div');
      item.className = 'column-item';
      item.draggable = true;
      item.dataset.columnKey = columnKey;
      
      const orderHtml = showOrder && order !== null 
        ? `<div class="column-item-order">${order}</div>` 
        : '';
      
      item.innerHTML = `
        ${orderHtml}
        <div class="column-item-info">
          <div class="column-item-name">${def.name}</div>
          <div class="column-item-desc">${def.desc}</div>
        </div>
        <div class="column-item-handle">â‹®â‹®</div>
      `;
      
      // Drag events
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragleave', handleDragLeave);
      
      return item;
    }

    /**
     * Get available columns based on selected data extractions
     */
    function getAvailableColumns() {
      const selectedExtractions = Array.from(
        document.querySelectorAll('#dataExtractGrid input[type="checkbox"]:checked')
      ).map(cb => cb.value);
      
      const available = [];
      
      // Always include basic fields
      available.push('nct_id', 'title', 'status');
      
      // Add fields based on selected extractions
      for (const [key, def] of Object.entries(COLUMN_DEFINITIONS)) {
        if (def.requires && selectedExtractions.includes(def.requires)) {
          available.push(key);
        }
      }
      
      return [...new Set(available)]; // Remove duplicates
    }

    /**
     * Update available columns pool
     */
    function updateAvailableColumns() {
      const pool = document.getElementById('columnPool');
      const selected = document.getElementById('columnSelected');
      
      if (!pool || !selected) return;
      
      const availableColumns = getAvailableColumns();
      const selectedColumns = Array.from(selected.querySelectorAll('.column-item'))
        .map(item => item.dataset.columnKey);
      
      // Clear pool
      pool.innerHTML = '';
      
      // Add columns that are available but not selected
      const poolColumns = availableColumns.filter(col => !selectedColumns.includes(col));
      
      poolColumns.forEach(columnKey => {
        const item = createColumnItem(columnKey, false);
        if (item) pool.appendChild(item);
      });
      
      // Update counts
      updateCounts();
    }

    /**
     * Update column counts
     */
    function updateCounts() {
      const poolCount = document.getElementById('columnPool')?.querySelectorAll('.column-item').length || 0;
      const selectedCount = document.getElementById('columnSelected')?.querySelectorAll('.column-item').length || 0;
      
      const poolCountEl = document.getElementById('poolCount');
      const selectedCountEl = document.getElementById('selectedCount');
      
      if (poolCountEl) poolCountEl.textContent = `${poolCount} column${poolCount !== 1 ? 's' : ''}`;
      if (selectedCountEl) selectedCountEl.textContent = `${selectedCount} column${selectedCount !== 1 ? 's' : ''}`;
      
      updateSelectedColumnOrders();
    }

    /**
     * Update order numbers in selected columns
     */
    function updateSelectedColumnOrders() {
      const selected = document.getElementById('columnSelected');
      if (!selected) return;
      
      const items = selected.querySelectorAll('.column-item');
      
      items.forEach((item, index) => {
        let orderEl = item.querySelector('.column-item-order');
        if (!orderEl) {
          orderEl = document.createElement('div');
          orderEl.className = 'column-item-order';
          item.insertBefore(orderEl, item.firstChild);
        }
        orderEl.textContent = index + 1;
      });
    }

    /**
     * Drag event handlers
     */
    function handleDragStart(e) {
      draggedElement = this;
      draggedFromPool = this.parentElement.id === 'columnPool';
      
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      
      // Remove drag-over class from all items
      document.querySelectorAll('.column-item').forEach(item => {
        item.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      
      e.dataTransfer.dropEffect = 'move';
      
      const target = e.target.closest('.column-item');
      if (target && target !== draggedElement) {
        target.classList.add('drag-over');
      }
      
      return false;
    }

    function handleDragLeave(e) {
      const target = e.target.closest('.column-item');
      if (target) {
        target.classList.remove('drag-over');
      }
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      e.target.classList.remove('drag-over');
      
      const dropTarget = e.target.closest('.column-item');
      const dropContainer = e.target.closest('.column-list');
      
      if (!draggedElement) return false;
      
      // Dropping into selected column list
      if (dropContainer && dropContainer.id === 'columnSelected') {
        if (dropTarget && dropTarget !== draggedElement) {
          // Insert before or after based on position
          const rect = dropTarget.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          
          if (e.clientY < midpoint) {
            dropContainer.insertBefore(draggedElement, dropTarget);
          } else {
            dropContainer.insertBefore(draggedElement, dropTarget.nextSibling);
          }
        } else if (!dropTarget) {
          // Dropped in empty space - append to end
          dropContainer.appendChild(draggedElement);
        }
        
        // If came from pool, remove from pool, otherwise just reorder
        if (draggedFromPool) {
          // Already moved, just update pool
          updateAvailableColumns();
        }
      }
      // Dropping back into pool
      else if (dropContainer && dropContainer.id === 'columnPool') {
        // Remove from selected and update pool
        if (draggedElement.parentElement.id === 'columnSelected') {
          draggedElement.remove();
          updateAvailableColumns();
        }
      }
      
      updateCounts();
      
      return false;
    }

    /**
     * Button actions
     */
    function clearAllColumns() {
      const selected = document.getElementById('columnSelected');
      if (selected) {
        selected.innerHTML = '';
        updateAvailableColumns();
        updateCounts();
      }
    }

    function selectDefaultColumns() {
      clearAllColumns();
      
      const defaultColumns = [
        'nct_id',
        'title', 
        'status',
        'lead_sponsor',
        'phase',
        'conditions'
      ];
      
      const selected = document.getElementById('columnSelected');
      if (!selected) return;
      
      defaultColumns.forEach(columnKey => {
        if (COLUMN_DEFINITIONS[columnKey]) {
          const item = createColumnItem(columnKey, true);
          if (item) selected.appendChild(item);
        }
      });
      
      updateAvailableColumns();
      updateCounts();
    }

    function selectAllColumns() {
      clearAllColumns();
      
      const availableColumns = getAvailableColumns();
      const selected = document.getElementById('columnSelected');
      if (!selected) return;
      
      availableColumns.forEach(columnKey => {
        const item = createColumnItem(columnKey, true);
        if (item) selected.appendChild(item);
      });
      
      updateAvailableColumns();
      updateCounts();
    }

    /**
     * Get selected columns in order
     */
    function getSelectedColumns() {
      const selected = document.getElementById('columnSelected');
      if (!selected) return [];
      
      return Array.from(selected.querySelectorAll('.column-item'))
        .map(item => item.dataset.columnKey);
    }

    // Setup drag and drop on container elements
    function setupDragDropContainers() {
      const selectedContainer = document.getElementById('columnSelected');
      const poolContainer = document.getElementById('columnPool');
      
      if (selectedContainer) {
        selectedContainer.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        selectedContainer.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (draggedElement && !selectedContainer.contains(draggedElement)) {
            selectedContainer.appendChild(draggedElement);
            updateAvailableColumns();
            updateCounts();
          }
        });
      }
      
      if (poolContainer) {
        poolContainer.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        poolContainer.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (draggedElement && draggedElement.parentElement.id === 'columnSelected') {
            draggedElement.remove();
            updateAvailableColumns();
            updateCounts();
          }
        });
      }
    }

    // Main application code
    let currentResults = null;

    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const toggle = document.getElementById(sectionId.replace('Section', 'Toggle'));
      
      content.classList.toggle('open');
      toggle.classList.toggle('open');
    }

    // Data extraction card selection
    document.getElementById('dataExtractGrid').addEventListener('click', (e) => {
      const card = e.target.closest('.org-type-card');
      if (!card) return;
      
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
      
      card.classList.toggle('selected', checkbox.checked);
      updateDataExtractSelectAll();
      
      // Update available columns when data extraction changes
      updateAvailableColumns();
    });

    function updateDataExtractSelectAll() {
      const allBoxes = Array.from(document.querySelectorAll('#dataExtractGrid input[type="checkbox"]'));
      const selectAll = document.getElementById('dataExtractSelectAll');
      const checkedCount = allBoxes.filter(b => b.checked).length;
      
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === allBoxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    document.getElementById('dataExtractSelectAll').addEventListener('change', (e) => {
      const allBoxes = document.querySelectorAll('#dataExtractGrid input[type="checkbox"]');
      const allCards = document.querySelectorAll('#dataExtractGrid .org-type-card');
      
      allBoxes.forEach(box => {
        box.checked = e.target.checked;
      });
      
      allCards.forEach(card => {
        card.classList.toggle('selected', e.target.checked);
      });
      
      e.target.indeterminate = false;
      
      // Update available columns
      updateAvailableColumns();
    });

    // Organization type card selection
    document.getElementById('orgTypesGrid').addEventListener('click', (e) => {
      const card = e.target.closest('.org-type-card');
      if (!card) return;
      
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
      
      card.classList.toggle('selected', checkbox.checked);
      updateOrgTypesSelectAll();
    });

    function updateOrgTypesSelectAll() {
      const allBoxes = Array.from(document.querySelectorAll('#orgTypesGrid input[type="checkbox"]'));
      const selectAll = document.getElementById('orgTypesSelectAll');
      const checkedCount = allBoxes.filter(b => b.checked).length;
      
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === allBoxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    document.getElementById('orgTypesSelectAll').addEventListener('change', (e) => {
      const allBoxes = document.querySelectorAll('#orgTypesGrid input[type="checkbox"]');
      const allCards = document.querySelectorAll('#orgTypesGrid .org-type-card');
      
      allBoxes.forEach(box => {
        box.checked = e.target.checked;
      });
      
      allCards.forEach(card => {
        card.classList.toggle('selected', e.target.checked);
      });
      
      e.target.indeterminate = false;
    });

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = 'âš ï¸ ' + message;
      errorDiv.classList.add('active');
      setTimeout(() => errorDiv.classList.remove('active'), 9000);
    }

    function setLoading(isLoading) {
      const loadingDiv = document.getElementById('loading');
      const btn = document.getElementById('searchBtn');
      if (isLoading) {
        loadingDiv.classList.add('active');
        btn.disabled = true;
      } else {
        loadingDiv.classList.remove('active');
        btn.disabled = false;
      }
    }

    function getCheckedValues(groupId) {
      const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`);
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function getSelectedOrgTypes() {
      const checkboxes = document.querySelectorAll('#orgTypesGrid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function getSelectedDataExtractions() {
      const checkboxes = document.querySelectorAll('#dataExtractGrid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    async function searchTrials() {
      const keywords = document.getElementById('keywords').value.trim();
      if (!keywords) {
        showError('Please enter at least one keyword.');
        return;
      }

      const selectedTypes = getSelectedOrgTypes();
      if (selectedTypes.length === 0) {
        showError('Please select at least one organization type.');
        return;
      }

      const selectedExtractions = getSelectedDataExtractions();
      if (selectedExtractions.length === 0) {
        showError('Please select at least one data field to extract.');
        return;
      }

      const selectedColumns = getSelectedColumns();
      if (selectedColumns.length === 0) {
        showError('Please add at least one column to the Excel export.');
        return;
      }

      document.getElementById('results').classList.remove('active');
      document.getElementById('error').classList.remove('active');
      setLoading(true);

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            keywords: keywords,
            statuses: getCheckedValues('status-group'),
            phases: getCheckedValues('phase-group'),
            maxResults: document.getElementById('maxResults').value,
            organizationTypes: selectedTypes,
            dataExtractions: selectedExtractions,
            columnOrder: selectedColumns
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Search failed');
        }

        currentResults = data;
        displayResults(data);

      } catch (error) {
        showError(error.message);
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('results');
      const statsDiv = document.getElementById('stats');
      const companiesList = document.getElementById('companiesList');

      statsDiv.innerHTML = `
        <div class="stat-box">
          <div class="stat-number">${data.stats.totalTrials}</div>
          <div class="stat-label">Trials Found</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.extractedRecords}</div>
          <div class="stat-label">Records Extracted</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.uniqueOrganizations || 0}</div>
          <div class="stat-label">Unique Organizations</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.dataFieldsExtracted}</div>
          <div class="stat-label">Data Fields</div>
        </div>
      `;

      const preview = data.preview || [];
      companiesList.innerHTML = preview.map(record => {
        const title = record.title || 'Untitled Study';
        const nctId = record.nct_id || '';
        const leadSponsor = record.lead_sponsor || 'N/A';
        const status = record.status || '';
        
        let additionalInfo = [];
        if (record.principal_investigators) {
          additionalInfo.push(`PI: ${record.principal_investigators.split('; ')[0]}`);
        }
        if (record.location_count) {
          additionalInfo.push(`${record.location_count} locations`);
        }
        if (record.intervention_count) {
          additionalInfo.push(`${record.intervention_count} interventions`);
        }
        
        return `
          <div class="company-item">
            <div style="flex: 1;">
              <div class="company-name">${title.substring(0, 80)}${title.length > 80 ? '...' : ''}</div>
              <div class="company-type">
                NCT: ${nctId} | Lead: ${leadSponsor} | Status: ${status}
              </div>
              ${additionalInfo.length > 0 ? `<div class="company-org-type">${additionalInfo.join(' â€¢ ')}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      if (preview.length < data.stats.extractedRecords) {
        companiesList.innerHTML += `
          <div style="text-align: center; padding: 20px; color: #6b7280;">
            Showing first 100 of ${data.stats.extractedRecords} records. 
            <br>Export Excel to see all data.
          </div>
        `;
      }

      resultsDiv.classList.add('active');
    }

    function exportToExcel() {
      window.open('/api/export/xlsx', '_blank');
    }

    function setupSelectAll(selectAllId, groupId) {
      const selectAll = document.getElementById(selectAllId);
      const boxes = Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]`));

      selectAll.addEventListener('change', () => {
        boxes.forEach(b => b.checked = selectAll.checked);
        selectAll.indeterminate = false;
      });

      boxes.forEach(b => b.addEventListener('change', () => {
        const checkedCount = boxes.filter(x => x.checked).length;
        if (checkedCount === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if (checkedCount === boxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }));
    }

    setupSelectAll('statusSelectAll', 'status-group');
    setupSelectAll('phaseSelectAll', 'phase-group');
    
    // Initialize column builder when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setupDragDropContainers();
      selectDefaultColumns();
    });
  </script>
</body>
</html>