<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clinical Trials Prospector</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5; padding: 20px; color: #333;
    }
    .container {
      max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px;
    }
    h1 { color: #2563eb; margin-bottom: 10px; font-size: 2em; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 1.1em; }
    .info-badge {
      background: #10b981; color: white; padding: 8px 15px; border-radius: 20px;
      display: inline-block; font-size: 0.9em; font-weight: 600; margin-bottom: 20px;
    }
    .section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 25px; margin-bottom: 20px;
    }
    .section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.2em; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;
      font-size: 14px; font-family: inherit;
    }
    textarea { min-height: 80px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .hint { font-size: 13px; color: #6b7280; margin-top: 5px; }
    .filters {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px; margin-top: 15px;
    }
    .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .checkbox-group label { 
      display: flex; gap: 8px; align-items: center; font-weight: normal;
      cursor: pointer;
    }
    
    /* New: Organization types section */
    .org-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }
    .org-type-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .org-type-card:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
    }
    .org-type-card.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }
    .org-type-card input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    .org-type-label {
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
    }
    .org-type-count {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .btn {
      width: 100%; padding: 14px; background: #2563eb; color: white;
      border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover:not(:disabled) { background: #1d4ed8; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .loading { text-align: center; padding: 30px; display: none; }
    .loading.active { display: block; }
    .spinner {
      width: 40px; height: 40px; margin: 0 auto 15px;
      border: 3px solid #e5e7eb; border-top: 3px solid #2563eb;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .status-text { color: #6b7280; font-size: 14px; }
    .error {
      background: #fee; border: 1px solid #fca5a5; color: #b91c1c;
      padding: 15px; border-radius: 6px; margin: 15px 0; display: none;
    }
    .error.active { display: block; }
    .results { margin-top: 30px; display: none; }
    .results.active { display: block; }
    .results-header {
      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .results-header h2 { color: #1e40af; margin-bottom: 15px; }
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    .stat-box { text-align: center; padding: 15px; background: white; border-radius: 6px; }
    .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; }
    .stat-label { color: #6b7280; font-size: 13px; margin-top: 5px; }
    .companies-section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .companies-list { max-height: 500px; overflow-y: auto; margin-top: 15px; }
    .company-item {
      background: white; border: 1px solid #e5e7eb; border-radius: 4px;
      padding: 12px 15px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .company-name { font-weight: 600; color: #1f2937; }
    .company-type { color: #6b7280; font-size: 13px; margin-top: 3px; }
    .company-org-type {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-top: 4px;
    }
    .company-count { color: #2563eb; font-weight: bold; font-size: 1.3em; }
    .export-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .btn-secondary { background: #10b981; }
    .btn-secondary:hover:not(:disabled) { background: #059669; }
    .info {
      background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;
      padding: 20px; margin-top: 25px;
    }
    .info h3 { color: #0369a1; margin-bottom: 12px; }
    .info ul { color: #0c4a6e; padding-left: 20px; }
    .info li { margin: 8px 0; line-height: 1.5; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Clinical Trials Prospector</h1>
    <p class="subtitle">Search for sponsors and collaborators from ClinicalTrials.gov</p>
    <div class="info-badge">âœ“ Flexible organization type filtering</div>

    <div class="section">
      <h3>Search Parameters</h3>

      <div class="form-group">
        <label for="keywords">Keywords *</label>
        <textarea id="keywords" placeholder="Enter keywords separated by commas (e.g., diabetes, CAR-T therapy, cardiovascular)"></textarea>
        <div class="hint">Tip: Use commas to add multiple keywords. Example: <b>mRNA, vaccine</b></div>
      </div>

      <div class="filters">
        <div class="form-group">
          <label>Study Status</label>
          <label style="margin-bottom:10px;">
            <input type="checkbox" id="statusSelectAll" />
            <span>Select all</span>
          </label>
          <div class="checkbox-group" id="status-group">
            <label><input type="checkbox" value="RECRUITING"> Recruiting</label>
            <label><input type="checkbox" value="ACTIVE_NOT_RECRUITING"> Active, not recruiting</label>
            <label><input type="checkbox" value="COMPLETED"> Completed</label>
            <label><input type="checkbox" value="ENROLLING_BY_INVITATION"> Enrolling by invitation</label>
            <label><input type="checkbox" value="NOT_YET_RECRUITING"> Not yet recruiting</label>
            <label><input type="checkbox" value="SUSPENDED"> Suspended</label>
            <label><input type="checkbox" value="TERMINATED"> Terminated</label>
            <label><input type="checkbox" value="WITHDRAWN"> Withdrawn</label>
          </div>
        </div>

        <div class="form-group">
          <label>Study Phase</label>
          <label style="margin-bottom:10px;">
            <input type="checkbox" id="phaseSelectAll" />
            <span>Select all</span>
          </label>
          <div class="checkbox-group" id="phase-group">
            <label><input type="checkbox" value="EARLY_PHASE1"> Early Phase 1</label>
            <label><input type="checkbox" value="PHASE1"> Phase 1</label>
            <label><input type="checkbox" value="PHASE2"> Phase 2</label>
            <label><input type="checkbox" value="PHASE3"> Phase 3</label>
            <label><input type="checkbox" value="PHASE4"> Phase 4</label>
          </div>
        </div>

        <div class="form-group">
          <label for="maxResults">Max Results</label>
          <select id="maxResults">
            <option value="100">100 studies</option>
            <option value="250">250 studies</option>
            <option value="500" selected>500 studies</option>
            <option value="1000">1000 studies</option>
            <option value="ALL">All results</option>
          </select>
        </div>
      </div>
    </div>

    <!-- NEW: Data to Extract Section -->
    <div class="section">
      <h3>Data to Extract</h3>
      <div class="hint" style="margin-bottom: 15px;">
        Select which information you want to collect from each trial. More selections = larger export file.
      </div>

      <label style="margin-bottom:15px; display: flex; gap: 8px; align-items: center; cursor: pointer;">
        <input type="checkbox" id="dataExtractSelectAll" />
        <span style="font-weight: 600; color: #1f2937;">Select All Data Fields</span>
      </label>

      <div class="org-types-grid" id="dataExtractGrid">
        <div class="org-type-card selected" data-extract="sponsors">
          <label>
            <input type="checkbox" value="sponsors" checked />
            <span class="org-type-label">Sponsors & Collaborators</span>
          </label>
          <div class="org-type-count">Lead sponsor, collaborators</div>
        </div>

        <div class="org-type-card" data-extract="investigators">
          <label>
            <input type="checkbox" value="investigators" />
            <span class="org-type-label">Principal Investigators</span>
          </label>
          <div class="org-type-count">Lead researchers, affiliations</div>
        </div>

        <div class="org-type-card" data-extract="locations">
          <label>
            <input type="checkbox" value="locations" />
            <span class="org-type-label">Study Locations</span>
          </label>
          <div class="org-type-count">Facilities, cities, countries</div>
        </div>

        <div class="org-type-card" data-extract="interventions">
          <label>
            <input type="checkbox" value="interventions" />
            <span class="org-type-label">Interventions</span>
          </label>
          <div class="org-type-count">Drugs, devices, procedures</div>
        </div>

        <div class="org-type-card" data-extract="conditions">
          <label>
            <input type="checkbox" value="conditions" />
            <span class="org-type-label">Conditions</span>
          </label>
          <div class="org-type-count">Diseases being studied</div>
        </div>

        <div class="org-type-card" data-extract="outcomes">
          <label>
            <input type="checkbox" value="outcomes" />
            <span class="org-type-label">Study Outcomes</span>
          </label>
          <div class="org-type-count">Primary, secondary measures</div>
        </div>

        <div class="org-type-card" data-extract="design">
          <label>
            <input type="checkbox" value="design" />
            <span class="org-type-label">Study Design</span>
          </label>
          <div class="org-type-count">Phase, enrollment, randomization</div>
        </div>

        <div class="org-type-card" data-extract="eligibility">
          <label>
            <input type="checkbox" value="eligibility" />
            <span class="org-type-label">Eligibility Criteria</span>
          </label>
          <div class="org-type-count">Age, gender, inclusion criteria</div>
        </div>

        <div class="org-type-card" data-extract="contacts">
          <label>
            <input type="checkbox" value="contacts" />
            <span class="org-type-label">Contact Information</span>
          </label>
          <div class="org-type-count">Recruitment contacts, emails</div>
        </div>

        <div class="org-type-card" data-extract="timeline">
          <label>
            <input type="checkbox" value="timeline" />
            <span class="org-type-label">Dates & Timeline</span>
          </label>
          <div class="org-type-count">Start, completion, update dates</div>
        </div>
      </div>
    </div>

    <!-- NEW: Organization Type Filtering -->
    <div class="section">
      <h3>Organization Types to Include</h3>
      <div class="hint" style="margin-bottom: 15px;">
        Select which types of organizations you want to see in the results. Check multiple types or use "Select All".
      </div>

      <label style="margin-bottom:15px; display: flex; gap: 8px; align-items: center; cursor: pointer;">
        <input type="checkbox" id="orgTypesSelectAll" />
        <span style="font-weight: 600; color: #1f2937;">Select All Organization Types</span>
      </label>

      <div class="org-types-grid" id="orgTypesGrid">
        <div class="org-type-card selected" data-type="company">
          <label>
            <input type="checkbox" value="company" checked />
            <span class="org-type-label">Commercial Companies</span>
          </label>
          <div class="org-type-count">Biotech, pharma, CROs, etc.</div>
        </div>

        <div class="org-type-card" data-type="university">
          <label>
            <input type="checkbox" value="university" />
            <span class="org-type-label">Universities & Colleges</span>
          </label>
          <div class="org-type-count">Academic institutions</div>
        </div>

        <div class="org-type-card" data-type="hospital">
          <label>
            <input type="checkbox" value="hospital" />
            <span class="org-type-label">Hospitals & Medical Centers</span>
          </label>
          <div class="org-type-count">Healthcare facilities</div>
        </div>

        <div class="org-type-card" data-type="institute">
          <label>
            <input type="checkbox" value="institute" />
            <span class="org-type-label">Research Institutes</span>
          </label>
          <div class="org-type-count">Independent research centers</div>
        </div>

        <div class="org-type-card" data-type="government">
          <label>
            <input type="checkbox" value="government" />
            <span class="org-type-label">Government Agencies</span>
          </label>
          <div class="org-type-count">NIH, VA, public health</div>
        </div>

        <div class="org-type-card" data-type="academic">
          <label>
            <input type="checkbox" value="academic" />
            <span class="org-type-label">Academic Medical Centers</span>
          </label>
          <div class="org-type-count">University hospitals</div>
        </div>

        <div class="org-type-card" data-type="foundation">
          <label>
            <input type="checkbox" value="foundation" />
            <span class="org-type-label">Foundations & Trusts</span>
          </label>
          <div class="org-type-count">Charitable organizations</div>
        </div>

        <div class="org-type-card" data-type="nonprofit">
          <label>
            <input type="checkbox" value="nonprofit" />
            <span class="org-type-label">Non-Profit Organizations</span>
          </label>
          <div class="org-type-count">Societies, associations</div>
        </div>
      </div>
    </div>

    <button class="btn" id="searchBtn" onclick="searchTrials()">Search Clinical Trials</button>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Loading...</div>
    </div>

    <div id="error" class="error"></div>

    <div id="results" class="results">
      <div class="results-header">
        <h2>Results</h2>
        <div class="stats" id="stats"></div>
      </div>

      <div class="companies-section">
        <h3>Extracted Data (Preview)</h3>
        <div class="companies-list" id="companiesList"></div>
      </div>

      <div class="export-buttons">
        <button class="btn btn-secondary" onclick="exportToCSV()">ðŸ“Š Export to Excel (XLSX)</button>
      </div>
    </div>

    <div class="info">
      <h3>Features</h3>
      <ul>
        <li><b>Flexible Data Extraction:</b> Choose exactly which data fields you need (10 categories available)</li>
        <li><b>Organization Filtering:</b> Select which organization types to include in results</li>
        <li><b>Select All Options:</b> Quickly include all types or all data fields with one click</li>
        <li><b>10 Data Categories:</b> Sponsors, investigators, locations, interventions, conditions, outcomes, design, eligibility, contacts, timeline</li>
        <li><b>8 Organization Types:</b> Companies, universities, hospitals, institutes, government, academic centers, foundations, non-profits</li>
        <li><b>Smart Export:</b> CSV includes only the data fields you selected</li>
      </ul>
    </div>
  </div>

  <script>
    let currentResults = null;

    // Data extraction card selection
    document.getElementById('dataExtractGrid').addEventListener('click', (e) => {
      const card = e.target.closest('.org-type-card');
      if (!card) return;
      
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
      
      card.classList.toggle('selected', checkbox.checked);
      updateDataExtractSelectAll();
    });

    // Select all data extraction functionality
    function updateDataExtractSelectAll() {
      const allBoxes = Array.from(document.querySelectorAll('#dataExtractGrid input[type="checkbox"]'));
      const selectAll = document.getElementById('dataExtractSelectAll');
      const checkedCount = allBoxes.filter(b => b.checked).length;
      
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === allBoxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    document.getElementById('dataExtractSelectAll').addEventListener('change', (e) => {
      const allBoxes = document.querySelectorAll('#dataExtractGrid input[type="checkbox"]');
      const allCards = document.querySelectorAll('#dataExtractGrid .org-type-card');
      
      allBoxes.forEach(box => {
        box.checked = e.target.checked;
      });
      
      allCards.forEach(card => {
        card.classList.toggle('selected', e.target.checked);
      });
      
      e.target.indeterminate = false;
    });

    // Organization type card selection
    document.getElementById('orgTypesGrid').addEventListener('click', (e) => {
      const card = e.target.closest('.org-type-card');
      if (!card) return;
      
      const checkbox = card.querySelector('input[type="checkbox"]');
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
      
      card.classList.toggle('selected', checkbox.checked);
      updateOrgTypesSelectAll();
    });

    // Select all organization types functionality
    function updateOrgTypesSelectAll() {
      const allBoxes = Array.from(document.querySelectorAll('#orgTypesGrid input[type="checkbox"]'));
      const selectAll = document.getElementById('orgTypesSelectAll');
      const checkedCount = allBoxes.filter(b => b.checked).length;
      
      if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCount === allBoxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    document.getElementById('orgTypesSelectAll').addEventListener('change', (e) => {
      const allBoxes = document.querySelectorAll('#orgTypesGrid input[type="checkbox"]');
      const allCards = document.querySelectorAll('#orgTypesGrid .org-type-card');
      
      allBoxes.forEach(box => {
        box.checked = e.target.checked;
      });
      
      allCards.forEach(card => {
        card.classList.toggle('selected', e.target.checked);
      });
      
      e.target.indeterminate = false;
    });

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = 'âš ï¸ ' + message;
      errorDiv.classList.add('active');
      setTimeout(() => errorDiv.classList.remove('active'), 9000);
    }

    function setLoading(isLoading) {
      const loadingDiv = document.getElementById('loading');
      const btn = document.getElementById('searchBtn');
      if (isLoading) {
        loadingDiv.classList.add('active');
        btn.disabled = true;
      } else {
        loadingDiv.classList.remove('active');
        btn.disabled = false;
      }
    }

    function getCheckedValues(groupId) {
      const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]:checked`);
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function getSelectedOrgTypes() {
      const checkboxes = document.querySelectorAll('#orgTypesGrid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function getSelectedDataExtractions() {
      const checkboxes = document.querySelectorAll('#dataExtractGrid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    async function searchTrials() {
      const keywords = document.getElementById('keywords').value.trim();
      if (!keywords) {
        showError('Please enter at least one keyword.');
        return;
      }

      const selectedTypes = getSelectedOrgTypes();
      if (selectedTypes.length === 0) {
        showError('Please select at least one organization type.');
        return;
      }

      const selectedExtractions = getSelectedDataExtractions();
      if (selectedExtractions.length === 0) {
        showError('Please select at least one data field to extract.');
        return;
      }

      document.getElementById('results').classList.remove('active');
      document.getElementById('error').classList.remove('active');
      setLoading(true);

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            keywords: keywords,
            statuses: getCheckedValues('status-group'),
            phases: getCheckedValues('phase-group'),
            maxResults: document.getElementById('maxResults').value,
            organizationTypes: selectedTypes,
            dataExtractions: selectedExtractions
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Search failed');
        }

        currentResults = data;
        displayResults(data);

      } catch (error) {
        showError(error.message);
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('results');
      const statsDiv = document.getElementById('stats');
      const companiesList = document.getElementById('companiesList');

      statsDiv.innerHTML = `
        <div class="stat-box">
          <div class="stat-number">${data.stats.totalTrials}</div>
          <div class="stat-label">Trials Found</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.extractedRecords}</div>
          <div class="stat-label">Records Extracted</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.uniqueOrganizations || 0}</div>
          <div class="stat-label">Unique Organizations</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${data.stats.dataFieldsExtracted}</div>
          <div class="stat-label">Data Fields</div>
        </div>
      `;

      // Display preview of extracted data
      const preview = data.preview || [];
      companiesList.innerHTML = preview.map(record => {
        const title = record.title || 'Untitled Study';
        const nctId = record.nct_id || '';
        const leadSponsor = record.lead_sponsor || 'N/A';
        const status = record.status || '';
        
        // Build additional info based on what was extracted
        let additionalInfo = [];
        if (record.principal_investigators) {
          additionalInfo.push(`PI: ${record.principal_investigators.split('; ')[0]}`);
        }
        if (record.location_count) {
          additionalInfo.push(`${record.location_count} locations`);
        }
        if (record.intervention_count) {
          additionalInfo.push(`${record.intervention_count} interventions`);
        }
        
        return `
          <div class="company-item">
            <div style="flex: 1;">
              <div class="company-name">${title.substring(0, 80)}${title.length > 80 ? '...' : ''}</div>
              <div class="company-type">
                NCT: ${nctId} | Lead: ${leadSponsor} | Status: ${status}
              </div>
              ${additionalInfo.length > 0 ? `<div class="company-org-type">${additionalInfo.join(' â€¢ ')}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      if (preview.length < data.stats.extractedRecords) {
        companiesList.innerHTML += `
          <div style="text-align: center; padding: 20px; color: #6b7280;">
            Showing first 100 of ${data.stats.extractedRecords} records. 
            <br>Export CSV to see all data.
          </div>
        `;
      }

      resultsDiv.classList.add('active');
    }

    function exportToCSV() {
      window.open('/api/export/csv', '_blank');
    }

    function setupSelectAll(selectAllId, groupId) {
      const selectAll = document.getElementById(selectAllId);
      const boxes = Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]`));

      selectAll.addEventListener('change', () => {
        boxes.forEach(b => b.checked = selectAll.checked);
        selectAll.indeterminate = false;
      });

      boxes.forEach(b => b.addEventListener('change', () => {
        const checkedCount = boxes.filter(x => x.checked).length;
        if (checkedCount === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        } else if (checkedCount === boxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        }
      }));
    }

    setupSelectAll('statusSelectAll', 'status-group');
    setupSelectAll('phaseSelectAll', 'phase-group');
  </script>
</body>
</html>