<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clinical Trials Prospector</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5; padding: 20px; color: #333;
    }
    .container {
      max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px;
    }
    h1 { color: #2563eb; margin-bottom: 10px; font-size: 2em; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 1.1em; }
    .section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 25px; margin-bottom: 20px;
    }
    .section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.2em; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;
      font-size: 14px; font-family: inherit;
    }
    textarea { min-height: 80px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .hint { font-size: 13px; color: #6b7280; margin-top: 5px; }
    .filters {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px; margin-top: 15px;
    }
    .btn {
      width: 100%; padding: 14px; background: #2563eb; color: white;
      border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover:not(:disabled) { background: #1d4ed8; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .loading { text-align: center; padding: 30px; display: none; }
    .loading.active { display: block; }
    .spinner {
      width: 40px; height: 40px; margin: 0 auto 15px;
      border: 3px solid #e5e7eb; border-top: 3px solid #2563eb;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .status-text { color: #6b7280; font-size: 14px; }
    .error {
      background: #fee; border: 1px solid #fca5a5; color: #b91c1c;
      padding: 15px; border-radius: 6px; margin: 15px 0; display: none;
      white-space: pre-wrap;
    }
    .error.active { display: block; }
    .results { margin-top: 30px; display: none; }
    .results.active { display: block; }
    .results-header {
      background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .results-header h2 { color: #1e40af; margin-bottom: 15px; }
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    .stat-box { text-align: center; padding: 15px; background: white; border-radius: 6px; }
    .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; }
    .stat-label { color: #6b7280; font-size: 13px; margin-top: 5px; }
    .companies-section {
      background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 20px; margin-bottom: 20px;
    }
    .companies-list { max-height: 500px; overflow-y: auto; margin-top: 15px; }
    .company-item {
      background: white; border: 1px solid #e5e7eb; border-radius: 4px;
      padding: 12px 15px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .company-name { font-weight: 600; color: #1f2937; }
    .company-type { color: #6b7280; font-size: 13px; margin-top: 3px; }
    .company-count { color: #2563eb; font-weight: bold; font-size: 1.3em; }
    .export-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .btn-secondary { background: #10b981; }
    .btn-secondary:hover:not(:disabled) { background: #059669; }
    .info {
      background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;
      padding: 20px; margin-top: 25px;
    }
    .info h3 { color: #0369a1; margin-bottom: 12px; }
    .info ul { color: #0c4a6e; padding-left: 20px; }
    .info li { margin: 8px 0; line-height: 1.5; }
    .small-note { font-size: 12px; color: #6b7280; margin-top: 6px; }
    .row-actions { display:flex; gap:10px; margin-top:10px; }
    .btn-outline {
      width: 100%;
      padding: 14px;
      background: white;
      color: #2563eb;
      border: 1px solid #2563eb;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-outline:hover:not(:disabled) { background: #eff6ff; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Clinical Trials Prospector</h1>
    <p class="subtitle">Search for sponsors and collaborators from ClinicalTrials.gov</p>

    <div class="section">
      <h3>Search Parameters</h3>

      <div class="form-group">
        <label for="keywords">Keywords *</label>
        <textarea id="keywords" placeholder="Enter keywords separated by commas (e.g., diabetes, CAR-T therapy, cardiovascular)"></textarea>
        <div class="hint">Tip: Use commas to add multiple keywords. Example: <b>mRNA, vaccine</b></div>
      </div>

      <div class="filters">
        <div class="form-group">
        <label>Study Status</label>

        <label style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
            <input type="checkbox" id="statusSelectAll" />
            Select all
        </label>

        <div id="status-group" style="display:flex;flex-direction:column;gap:8px;">
            <label><input type="checkbox" value="RECRUITING"> Recruiting</label>
            <label><input type="checkbox" value="ACTIVE_NOT_RECRUITING"> Active, not recruiting</label>
            <label><input type="checkbox" value="COMPLETED"> Completed</label>
            <label><input type="checkbox" value="ENROLLING_BY_INVITATION"> Enrolling by invitation</label>
            <label><input type="checkbox" value="NOT_YET_RECRUITING"> Not yet recruiting</label>
            <label><input type="checkbox" value="SUSPENDED"> Suspended</label>
            <label><input type="checkbox" value="TERMINATED"> Terminated</label>
            <label><input type="checkbox" value="WITHDRAWN"> Withdrawn</label>
        </div>
        </div>

        <div class="form-group">
        <label>Study Phase</label>

        <label style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
            <input type="checkbox" id="phaseSelectAll" />
            Select all
        </label>

        <div id="phase-group" style="display:flex;flex-direction:column;gap:8px;">
            <label><input type="checkbox" value="EARLY_PHASE1"> Early Phase 1</label>
            <label><input type="checkbox" value="PHASE1"> Phase 1</label>
            <label><input type="checkbox" value="PHASE2"> Phase 2</label>
            <label><input type="checkbox" value="PHASE3"> Phase 3</label>
            <label><input type="checkbox" value="PHASE4"> Phase 4</label>
        </div>
        </div>

        <div class="form-group">
          <label for="maxResults">Max Results</label>
          <select id="maxResults">
            <option value="100">100 studies</option>
            <option value="250">250 studies</option>
            <option value="500" selected>500 studies</option>
            <option value="1000">1000 studies</option>
            <option value="ALL">All results</option>
          </select>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="searchBtn" onclick="searchTrials()">Search Clinical Trials</button>
        <button class="btn-outline" onclick="testApi()">Test API (mRNA, 1 study)</button>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Loading...</div>
    </div>

    <div id="error" class="error"></div>

    <div id="results" class="results">
      <div class="results-header">
        <h2>Results</h2>
        <div class="stats" id="stats"></div>
      </div>

      <div class="companies-section">
        <h3>Companies Found</h3>
        <div class="companies-list" id="companiesList"></div>
      </div>

      <div class="export-buttons">
        <button class="btn btn-secondary" onclick="exportToExcel()">ðŸ“Š Export to Excel</button>
        <button class="btn" onclick="exportToCSV()">ðŸ“„ Export to CSV (PhantomBuster)</button>
      </div>
    </div>

    <div class="info">
      <h3>Instructions</h3>
      <ul>
        <li>Enter keywords related to your therapeutic area (comma-separated)</li>
        <li>Optional: select multiple statuses and phases</li>
        <li>Click Search to query ClinicalTrials.gov API (v2) with proper pagination</li>
        <li>Export results in Excel (detailed) or CSV (for PhantomBuster)</li>
      </ul>
    </div>
  </div>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    let trialsData = [];
    // key: company name (raw), value: {name, leadCount, collabCount, trialCount, nctIds:Set}
    let companiesData = new Map();

    // -----------------------------
    // Helpers
    // -----------------------------
    function updateStatus(text) {
      document.getElementById('statusText').textContent = text;
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = 'âš ï¸ ' + message;
      errorDiv.classList.add('active');
      setTimeout(() => errorDiv.classList.remove('active'), 9000);
    }

    function setLoading(isLoading) {
      const loadingDiv = document.getElementById('loading');
      const btn = document.getElementById('searchBtn');
      if (isLoading) {
        loadingDiv.classList.add('active');
        btn.disabled = true;
      } else {
        loadingDiv.classList.remove('active');
        btn.disabled = false;
      }
    }

    function getSelectedValues(selectId) {
      const el = document.getElementById(selectId);
      return Array.from(el.selectedOptions).map(o => o.value).filter(Boolean);
    }

    function escapeCSV(value) {
      const s = String(value ?? '');
      if (s.includes('"') || s.includes(',') || s.includes('\n')) {
        return `"${s.replaceAll('"', '""')}"`;
      }
      return s;
    }

    // Build a robust query.term:
    // - keywords combined as (k1 OR k2 OR k3)
    // - optional phase added via AREA[Phase](...)
    function buildQueryTerm(keywordArray, phases) {
      const keywordPart = keywordArray.length === 1
        ? keywordArray[0]
        : `(${keywordArray.map(k => `"${k}"`).join(' OR ')})`;

      if (!phases || phases.length === 0) return keywordPart;

      const phasePart = `AREA[Phase](${phases.join(' OR ')})`;
      return `${keywordPart} AND ${phasePart}`;
    }

    async function fetchJsonOrThrow(url) {
      const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
      const text = await res.text();
      if (!res.ok) {
        // include response body for easier debugging
        throw new Error(`API returned ${res.status}.\nURL: ${url}\nBody: ${text.slice(0, 800)}`);
      }
      try {
        return JSON.parse(text);
      } catch {
        throw new Error(`Non-JSON response.\nURL: ${url}\nBody: ${text.slice(0, 800)}`);
      }
    }

    // -----------------------------
    // API Test (only API, no processing)
    // -----------------------------
    async function testApi() {
      setLoading(true);
      document.getElementById('results').classList.remove('active');
      document.getElementById('error').classList.remove('active');
      updateStatus('Testing API (mRNA, 1 study)...');

      try {
        const params = new URLSearchParams();
        params.set('query.term', 'mRNA');
        params.set('pageSize', '1');
        params.set('format', 'json');
        const url = `https://clinicaltrials.gov/api/v2/studies?${params.toString()}`;

        const data = await fetchJsonOrThrow(url);
        setLoading(false);
        alert('âœ… API OK. Example keys: ' + Object.keys(data).join(', '));
        console.log('API test response:', data);
      } catch (e) {
        setLoading(false);
        showError(e.message);
      }
    }

    // -----------------------------
    // Main search
    // -----------------------------
    async function searchTrials() {
      const keywordsRaw = document.getElementById('keywords').value.trim();
      if (!keywordsRaw) {
        showError('Please enter at least one keyword.');
        return;
      }

      // Reset state/UI
      trialsData = [];
      companiesData = new Map();
      document.getElementById('results').classList.remove('active');
      document.getElementById('error').classList.remove('active');

      setLoading(true);
      updateStatus('Preparing search...');

      try {
        const keywordArray = keywordsRaw.split(',').map(k => k.trim()).filter(Boolean);
        const statuses = Array.from(document.querySelectorAll('#status-group input[type="checkbox"]:checked'))
        .map(cb => cb.value);
        const phases = Array.from(document.querySelectorAll('#phase-group input[type="checkbox"]:checked'))
        .map(cb => cb.value);
        const maxResultsRaw = document.getElementById('maxResults').value;
        const maxResults = (maxResultsRaw === "ALL") ? Infinity : parseInt(maxResultsRaw, 10);

        // Build query.term for robust filtering (incl phases)
        const queryTerm = buildQueryTerm(keywordArray, phases);

        // Pagination via nextPageToken (correct for v2)
        const pageSize = 100;
        let pageToken = null;

        updateStatus('Fetching data from ClinicalTrials.gov...');

        while (trialsData.length < maxResults) {
          const params = new URLSearchParams();
          params.set('query.term', queryTerm);
          params.set('pageSize', String(Math.min(pageSize, maxResults - trialsData.length)));
          params.set('format', 'json');
          params.set('countTotal', 'true');

          // Status filter: comma-separated values in ONE param
          if (statuses.length > 0) params.set('filter.overallStatus', statuses.join(','));
          if (pageToken) params.set('pageToken', pageToken);

          const url = `https://clinicaltrials.gov/api/v2/studies?${params.toString()}`;

          updateStatus(`Fetchingâ€¦ (${trialsData.length}/${maxResults})`);
          const data = await fetchJsonOrThrow(url);

          const studies = Array.isArray(data.studies) ? data.studies : [];
          trialsData.push(...studies);

          pageToken = data.nextPageToken || null;
          if (!pageToken || studies.length === 0) break;

          // small delay to be polite
          await new Promise(r => setTimeout(r, 150));
        }

        updateStatus('Processing sponsors & collaboratorsâ€¦');
        extractCompaniesFromTrials(trialsData);

        setLoading(false);
        displayResults();

      } catch (e) {
        setLoading(false);
        showError(e.message);
        console.error(e);
      }
    }

    function upsertCompany(name, role, nctId) {
      const key = String(name || '').trim();
      if (!key) return;

      if (!companiesData.has(key)) {
        companiesData.set(key, {
          name: key,
          leadCount: 0,
          collabCount: 0,
          trialCount: 0,
          nctIds: new Set()
        });
      }
      const c = companiesData.get(key);

      if (role === 'LEAD') c.leadCount += 1;
      if (role === 'COLLAB') c.collabCount += 1;

      c.trialCount += 1;
      if (nctId) c.nctIds.add(nctId);
    }

    function extractCompaniesFromTrials(studies) {
      for (const study of studies) {
        try {
          const ps = study.protocolSection || {};
          const id = ps.identificationModule || {};
          const nctId = id.nctId || '';

          // Correct module name (note the plural "sponsors")
          const sc = ps.sponsorsCollaboratorsModule || ps.sponsorCollaboratorsModule || {};

          if (sc.leadSponsor && sc.leadSponsor.name) {
            upsertCompany(sc.leadSponsor.name, 'LEAD', nctId);
          }

          const collaborators = Array.isArray(sc.collaborators) ? sc.collaborators : [];
          for (const collab of collaborators) {
            if (collab && collab.name) upsertCompany(collab.name, 'COLLAB', nctId);
          }
        } catch (err) {
          console.warn('Error processing a study:', err);
        }
      }
    }

    function displayResults() {
      const resultsDiv = document.getElementById('results');
      const statsDiv = document.getElementById('stats');
      const companiesList = document.getElementById('companiesList');

      const totalTrials = trialsData.length;
      const uniqueCompanies = companiesData.size;

      let sponsors = 0, collaborators = 0;
      for (const c of companiesData.values()) {
        if (c.leadCount > 0) sponsors += 1;
        if (c.collabCount > 0) collaborators += 1;
      }

      statsDiv.innerHTML = `
        <div class="stat-box">
          <div class="stat-number">${totalTrials}</div>
          <div class="stat-label">Trials Found</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${uniqueCompanies}</div>
          <div class="stat-label">Companies</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${sponsors}</div>
          <div class="stat-label">Companies as Lead Sponsor</div>
        </div>
        <div class="stat-box">
          <div class="stat-number">${collaborators}</div>
          <div class="stat-label">Companies as Collaborator</div>
        </div>
      `;

      const sortedCompanies = Array.from(companiesData.values())
        .sort((a, b) => b.trialCount - a.trialCount);

      companiesList.innerHTML = sortedCompanies.map(c => {
        const roleLabel =
          (c.leadCount > 0 && c.collabCount > 0) ? 'Lead Sponsor + Collaborator' :
          (c.leadCount > 0) ? 'Lead Sponsor' : 'Collaborator';

        return `
          <div class="company-item">
            <div>
              <div class="company-name">${c.name}</div>
              <div class="company-type">${roleLabel}</div>
            </div>
            <div class="company-count">${c.trialCount}</div>
          </div>
        `;
      }).join('');

      resultsDiv.classList.add('active');
    }

    // -----------------------------
    // Export
    // -----------------------------
    function exportToExcel() {
      if (companiesData.size === 0) {
        showError('No data to export.');
        return;
      }

      const wb = XLSX.utils.book_new();

      // Companies sheet
      const companiesArray = Array.from(companiesData.values())
        .sort((a, b) => b.trialCount - a.trialCount)
        .map(c => ({
          'Company Name': c.name,
          'Role': (c.leadCount > 0 && c.collabCount > 0) ? 'Lead+Collaborator' : (c.leadCount > 0 ? 'Lead Sponsor' : 'Collaborator'),
          'Lead Sponsor Mentions': c.leadCount,
          'Collaborator Mentions': c.collabCount,
          'Total Mentions': c.trialCount,
          'NCT IDs': Array.from(c.nctIds).join(', ')
        }));

      const ws1 = XLSX.utils.json_to_sheet(companiesArray);
      XLSX.utils.book_append_sheet(wb, ws1, 'Companies');

      // Trials sheet
      const trialsArray = trialsData.map(study => {
        const ps = study.protocolSection || {};
        const id = ps.identificationModule || {};
        const status = ps.statusModule || {};
        const design = ps.designModule || {};
        const cond = ps.conditionsModule || {};
        const sc = ps.sponsorsCollaboratorsModule || ps.sponsorCollaboratorsModule || {};

        const collaborators = Array.isArray(sc.collaborators) ? sc.collaborators : [];

        return {
          'NCT ID': id.nctId || '',
          'Title': id.briefTitle || '',
          'Status': status.overallStatus || '',
          'Phase': Array.isArray(design.phases) ? design.phases.join(', ') : '',
          'Lead Sponsor': (sc.leadSponsor && sc.leadSponsor.name) ? sc.leadSponsor.name : '',
          'Collaborators': collaborators.map(c => c?.name).filter(Boolean).join('; '),
          'Conditions': Array.isArray(cond.conditions) ? cond.conditions.join('; ') : '',
          'Start Date': (status.startDateStruct && status.startDateStruct.date) ? status.startDateStruct.date : '',
          'URL': id.nctId ? `https://clinicaltrials.gov/study/${id.nctId}` : ''
        };
      });

      const ws2 = XLSX.utils.json_to_sheet(trialsArray);
      XLSX.utils.book_append_sheet(wb, ws2, 'Trials');

      const date = new Date().toISOString().split('T')[0];
      XLSX.writeFile(wb, `ClinicalTrials_Export_${date}.xlsx`);
    }

    function exportToCSV() {
      if (companiesData.size === 0) {
        showError('No data to export.');
        return;
      }

      const companiesArray = Array.from(companiesData.values())
        .sort((a, b) => b.trialCount - a.trialCount);

      const headers = [
        'Company Name',
        'Role',
        'Lead Sponsor Mentions',
        'Collaborator Mentions',
        'Total Mentions',
        'LinkedIn Company Search URL'
      ];

      let csv = headers.join(',') + '\n';

      for (const c of companiesArray) {
        const role =
          (c.leadCount > 0 && c.collabCount > 0) ? 'Lead+Collaborator' :
          (c.leadCount > 0) ? 'Lead Sponsor' : 'Collaborator';

        const searchURL = `https://www.linkedin.com/search/results/companies/?keywords=${encodeURIComponent(c.name)}`;
        const row = [
          escapeCSV(c.name),
          escapeCSV(role),
          escapeCSV(c.leadCount),
          escapeCSV(c.collabCount),
          escapeCSV(c.trialCount),
          escapeCSV(searchURL)
        ];
        csv += row.join(',') + '\n';
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().split('T')[0];
      a.download = `ClinicalTrials_PhantomBuster_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

function setupSelectAll(selectAllId, groupId) {
    const selectAll = document.getElementById(selectAllId);
    const boxes = Array.from(document.querySelectorAll(`#${groupId} input[type="checkbox"]`));

  // Select all -> check/uncheck all
    selectAll.addEventListener('change', () => {
        boxes.forEach(b => b.checked = selectAll.checked);
        selectAll.indeterminate = false;
    });

    // If user manually changes a checkbox -> update Select all state
    boxes.forEach(b => b.addEventListener('change', () => {
        const checkedCount = boxes.filter(x => x.checked).length;

        if (checkedCount === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
        } else if (checkedCount === boxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
        } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
        }
    }));
    }

// Call once on load
setupSelectAll('statusSelectAll', 'status-group');
setupSelectAll('phaseSelectAll', 'phase-group');

  </script>
</body>
</html>
